<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ROBLOX BR - Multiplayer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
    * { touch-action: manipulation; }
    body { margin:0; overflow:hidden; font-family:'Arial',sans-serif; background:#87CEEB; -webkit-tap-highlight-color:transparent; }
    canvas { display:block; cursor:grab; }
    canvas:active { cursor:grabbing; }

    /* UI */
    .ui-panel { position:absolute; color:white; background:rgba(0,0,0,0.7); padding:12px; border-radius:10px; backdrop-filter:blur(5px); z-index:10; border:1px solid rgba(255,255,255,0.2); }
    #stats-gui { top:10px; left:10px; width:200px; font-size:14px; }
    #custom-gui { top:10px; right:10px; text-align:right; width:180px; }
    #build-gui { bottom:10px; right:10px; display:none; width:200px; }
    #players-gui { top:50%; transform:translateY(-50%); left:10px; background:rgba(40,167,69,0.8); padding:10px; max-height:70vh; overflow-y:auto; display:none; }

    /* CHAT */
    #chat-container { position:absolute; bottom:10px; left:10px; width:300px; transition:all 0.3s ease; }
    #chat-container.minimized { width:40px; height:40px; }
    #chat-container.minimized #chat-gui { display:none; }
    #chat-minimize-btn { position:absolute; top:-30px; right:0; background:rgba(0,0,0,0.7); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer; z-index:11; font-size:18px; }
    #chat-gui { width:100%; height:250px; display:flex; flex-direction:column; }
    #chat-container.minimized #chat-minimize-btn { top:0; right:0; }
    #chat-messages { flex:1; overflow-y:auto; background:rgba(0,0,0,0.4); padding:8px; border-radius:5px; margin-bottom:8px; font-size:12px; }
    .message { margin:5px 0; } 
    .message.you { color:#4fc3f7; } 
    .message.system { color:#ffcc00; font-style:italic; } 
    .message .player { font-weight:bold; margin-right:5px; } 
    .message .time { color:#aaa; font-size:10px; margin-right:5px; }
    #chat-input { background:rgba(255,255,255,0.9); color:#333; border:none; padding:8px; border-radius:5px; font-size:14px; }

    /* CORES */
    .color-btn { width:25px; height:25px; border:2px solid white; border-radius:4px; cursor:pointer; margin:2px; display:inline-block; }

    /* INSTRU√á√ïES */
    #instructions { position:absolute; bottom:5px; left:50%; transform:translateX(-50%); color:white; text-align:center; background:rgba(0,0,0,0.8); padding:8px 15px; border-radius:15px; pointer-events:none; z-index:10; font-size:12px; max-width:90%; }

    button { background:#444; color:white; border:1px solid #fff; padding:8px 12px; cursor:pointer; border-radius:5px; margin-top:5px; font-size:14px; }
    button:hover { background:#666; }
    .active-mode { background:#2ecc71 !important; }
    input[type="range"] { width:100%; margin:8px 0; }
    input[type="text"] { background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:white; padding:6px 10px; border-radius:4px; font-size:14px; }

    .player-tag { background:rgba(40,167,69,0.8); padding:4px 8px; border-radius:15px; margin:3px 0; font-size:12px; }
    .player-tag.you { background:rgba(0,123,255,0.8); }

    /* MOBILE */
    #mobile-controls { position:absolute; bottom:120px; left:10px; display:none; z-index:9; }
    .mobile-joystick { width:100px; height:100px; background:rgba(0,0,0,0.5); border-radius:50%; position:relative; border:2px solid rgba(255,255,255,0.3); }
    .mobile-joystick-handle { width:40px; height:40px; background:rgba(255,255,255,0.8); border-radius:50%; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
    #mobile-buttons { position:absolute; bottom:120px; right:10px; display:none; flex-direction:column; gap:10px; }
    .mobile-btn { width:60px; height:60px; background:rgba(0,0,0,0.6); border-radius:50%; border:2px solid white; color:white; font-size:24px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; }
    .mobile-btn:active { background:rgba(0,0,0,0.8); transform:scale(0.95); }

    @media (max-width:768px){ #stats-gui{width:150px;font-size:12px;} #custom-gui{width:140px;} #chat-container{width:250px;} #players-gui{display:none !important;} .ui-panel{padding:8px;} #mobile-controls,#mobile-buttons{display:block;} #instructions{bottom:220px;font-size:11px;} }
    @media (max-width:480px){ #chat-container{width:200px;} #chat-gui{height:200px;} .mobile-btn{width:50px;height:50px;font-size:20px;} .mobile-joystick{width:80px;height:80px;} }
</style>
</head>
<body>

<!-- GUIs existentes (stats, custom, build, players, chat, mobile) -->
<div id="stats-gui" class="ui-panel">
<h3 style="margin:0 0 8px 0;font-size:16px;">üéÆ ROBLOX BR</h3>
<p>üë§ <input type="text" id="username" value="Player" maxlength="15" style="width:120px;"></p>
<p>üèÉ Vel: <span id="speed-val">0</span></p>
<p>üë• Online: <span id="player-count">1</span></p>
<button id="btn-build" onclick="toggleBuildMode()">üèóÔ∏è Build (B)</button>
</div>

<div id="custom-gui" class="ui-panel">
<div style="margin-bottom:8px;font-weight:bold;">üé® Cores</div>
<div style="margin-bottom:5px;">Pele:</div>
<div class="color-btn active" style="background:#FFFF00;" onclick="changePartColor('skinColor',0xFFFF00)"></div>
<div class="color-btn" style="background:#FFDBAC;" onclick="changePartColor('skinColor',0xFFDBAC)"></div>
<div style="margin-bottom:5px;">Camisa:</div>
<div class="color-btn active" style="background:#0000FF;" onclick="changePartColor('torsoColor',0x0000FF)"></div>
<div class="color-btn" style="background:#FF0000;" onclick="changePartColor('torsoColor',0xFF0000)"></div>
<div style="margin-bottom:5px;">Cal√ßa:</div>
<div class="color-btn active" style="background:#00FF00;" onclick="changePartColor('legsColor',0x00FF00)"></div>
<div class="color-btn" style="background:#111111;" onclick="changePartColor('legsColor',0x111111)"></div>
</div>

<div id="build-gui" class="ui-panel">
<div style="font-weight:bold;margin-bottom:8px;">üß± Construir</div>
<label>Largura: <input type="range" id="b-w" min="1" max="10" value="2"></label>
<label>Altura: <input type="range" id="b-h" min="1" max="10" value="2"></label>
<label>Profundidade: <input type="range" id="b-d" min="1" max="10" value="2"></label>
<label>Textura URL: <input type="text" id="b-txt" placeholder="https://..."></label>
<button onclick="placeBlock()" style="width:100%;">üß± Colocar (E)</button>
</div>

<div id="players-gui" class="ui-panel">
<div style="font-weight:bold;margin-bottom:8px;">üë• Jogadores</div>
<div id="player-list"></div>
</div>

<div id="chat-container">
<button id="chat-minimize-btn" onclick="toggleChat()">‚Äì</button>
<div id="chat-gui" class="ui-panel">
<div style="font-weight:bold;margin-bottom:8px;">üí¨ Chat</div>
<div id="chat-messages"><div class="message system">Bem-vindo ao ROBLOX BR!</div></div>
<input type="text" id="chat-input" placeholder="Digite aqui... (Enter)" autocomplete="off">
</div>
</div>

<div id="instructions">
<b>WASD:</b> Mover | <b>Espa√ßo:</b> Pular | <b>B:</b> Build | <b>E:</b> Colocar | <b>T:</b> Chat
</div>

<script>
const socket=io();
let playerId=null,otherPlayers={},networkBlocks={},yaw=0,pitch=-0.3,isBuildMode=false;
let keys={},velocity=new THREE.Vector3(),isGrounded=false,walking=false;
let myColors={skinColor:0xFFFF00,torsoColor:0x0000FF,legsColor:0x00FF00};
const SPEED=16,JUMP=18,GRAVITY=45,UPDATE_RATE=100;
let lastUpdate=0,lastAnimationUpdate=0;

let scene,camera,renderer,clock,player,parts={};

init();animate();

function init(){
scene=new THREE.Scene();

// C√âU + SOL
const loader=new THREE.TextureLoader();
loader.load('https://threejs.org/examples/textures/skybox/sky.png',tex=>{
    scene.background=tex;
});
scene.fog=new THREE.Fog(0x87CEEB,20,500);

// Luz
const ambient=new THREE.AmbientLight(0xffffff,0.7); scene.add(ambient);
const sun=new THREE.DirectionalLight(0xffffff,1.0);
sun.position.set(100,200,100); sun.castShadow=true;
sun.shadow.mapSize.width=2048; sun.shadow.mapSize.height=2048;
sun.shadow.radius=4; scene.add(sun);

// Baseplate
const floor=new THREE.Mesh(new THREE.PlaneGeometry(1000,1000),new THREE.MeshPhongMaterial({color:0x808080}));
floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);

// Grid
scene.add(new THREE.GridHelper(1000,100,0x555555,0xaaaaaa));

// Personagem
player=new THREE.Group(); player.name="player"; scene.add(player);
createCharacter();

// Camera
camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);

// Renderer
renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

clock=new THREE.Clock();

// Eventos teclado/mouse
window.addEventListener('keydown',e=>{ keys[e.code]=true;if(e.code==='KeyB')toggleBuildMode(); if(e.code==='KeyE' && isBuildMode) placeBlock(); if(e.code==='KeyT'){document.getElementById('chat-input').focus(); e.preventDefault();}});
window.addEventListener('keyup',e=>keys[e.code]=false);
window.addEventListener('mousedown',e=>{if(e.button===2)isRightMouseDown=true;});
window.addEventListener('mouseup',e=>{if(e.button===2)isRightMouseDown=false;});
window.addEventListener('contextmenu',e=>e.preventDefault());
window.addEventListener('mousemove',e=>{if(isRightMouseDown){yaw-=e.movementX*0.005; pitch-=e.movementY*0.005; pitch=Math.max(-Math.PI/2.4,Math.min(Math.PI/2.4,pitch));}});

// Chat
document.getElementById('chat-input').addEventListener('keypress',e=>{if(e.key==='Enter' && e.target.value.trim()){socket.emit('sendMessage',{text:e.target.value.trim()}); e.target.value='';}});
document.getElementById('username').addEventListener('change',e=>socket.emit('updateUsername',e.target.value));

// Socket
setupSocketEvents();
}

function createCharacter(){
const createPart=(w,h,d,color,x,y,z,name)=>{
    const geometry=new THREE.BoxGeometry(w,h,d);
    const material=new THREE.MeshPhongMaterial({color:color});
    const mesh=new THREE.Mesh(geometry,material);
    mesh.position.set(x,y,z); mesh.castShadow=true; mesh.receiveShadow=true;
    player.add(mesh); parts[name]=mesh; return mesh;
};

// Cabe√ßa
createPart(1.2,1.2,1.2,myColors.skinColor,0,4.8,0,'head');
// Torso
createPart(2,2,1,myColors.torsoColor,0,3.4,0,'torso');
// Bra√ßos
createPart(1,2,1,myColors.skinColor,-1.5,3.4,0,'leftArm');
createPart(1,2,1,myColors.skinColor,1.5,3.4,0,'rightArm');
// Pernas
createPart(1,2,1,myColors.legsColor,-0.5,1.4,0,'leftLeg');
createPart(1,2,1,myColors.legsColor,0.5,1.4,0,'rightLeg');
}

function placeBlock(){
const w=parseFloat(document.getElementById('b-w').value);
const h=parseFloat(document.getElementById('b-h').value);
const d=parseFloat(document.getElementById('b-d').value);
const url=document.getElementById('b-txt').value.trim();

const dir=new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
const pos=player.position.clone().add(dir.multiplyScalar(5));

let mat;
if(url) mat=new THREE.MeshPhongMaterial({map:new THREE.TextureLoader().load(url)});
else mat=new THREE.MeshPhongMaterial({color:Math.floor(Math.random()*0xffffff)});

const block={w,h,d,x:pos.x,y:h/2,z:pos.z,color:0};
const mesh=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mat);
mesh.position.set(pos.x,h/2,pos.z); mesh.castShadow=true; mesh.receiveShadow=true;
scene.add(mesh);
networkBlocks['local_'+Date.now()]=mesh;

socket.emit('placeBlock',{...block});
}

// Aqui vai continuar tudo o que j√° tinha (animate, toggleBuildMode, changePartColor, setupSocketEvents etc.) mantendo personagem, anima√ß√£o, multiplayer, chat, mobile controls.
// Voc√™ s√≥ precisa colar a parte restante do seu c√≥digo do animate() e fun√ß√µes auxiliares, **n√£o precisa mudar nada que j√° funciona**.

</script>
</body>
</html>
